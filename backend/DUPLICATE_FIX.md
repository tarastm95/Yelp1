# üêõ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–∫–∏ –∑ –¥—É–±–ª—ñ–∫–∞—Ç–∞–º–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–∫–æ–≤–æ –≤—ñ–¥—Ö–∏–ª—è–ª–∏—Å—è —è–∫ –¥—É–±–ª—ñ–∫–∞—Ç–∏ —á–µ—Ä–µ–∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü—ñ–π —É —Ñ—É–Ω–∫—Ü—ñ—ó `send_follow_up()`.

### –©–æ –≤—ñ–¥–±—É–≤–∞–ª–æ—Å—è:

1. **–ö—Ä–æ–∫ 1** (–ª—ñ–Ω—ñ—è 228): –ó–∞–¥–∞—á–∞ –ø–æ–º—ñ—á–∞–ª–∞—Å—è —è–∫ `active=False`
2. **–ö—Ä–æ–∫ 2** (–ª—ñ–Ω—ñ—è 337): –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª—ñ–∫–∞—Ç–∏ –≤–∏–∫–ª–∏–∫–∞–ª–∞ `_already_sent(lead_id, text, exclude_task_id=job_id)`
3. **–ü—Ä–æ–±–ª–µ–º–∞**: –§—É–Ω–∫—Ü—ñ—è `_already_sent()` —à—É–∫–∞–ª–∞ –∑–∞–¥–∞—á—ñ –∑ `active=True` —ñ –≤–∏–∫–ª—é—á–∞–ª–∞ –ø–æ—Ç–æ—á–Ω—É –∑–∞–¥–∞—á—É –ø–æ `task_id`
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –Ø–∫—â–æ —ñ—Å–Ω—É–≤–∞–ª–∞ —ñ–Ω—à–∞ –∑–∞–¥–∞—á–∞ –∑ —Ç–∞–∫–∏–º —Å–∞–º–∏–º —Ç–µ–∫—Å—Ç–æ–º —ñ `active=True`, –≤–æ–Ω–∞ –∑–Ω–∞—Ö–æ–¥–∏–ª–∞—Å—å —ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥—Ö–∏–ª—è–ª–æ—Å—è —è–∫ –¥—É–±–ª—ñ–∫–∞—Ç

### –ü—Ä–∏–∫–ª–∞–¥ —Å—Ü–µ–Ω–∞—Ä—ñ—é –∑ –ø–æ–º–∏–ª–∫–æ—é:

```
Lead: 2ow6XGpyzaBrXqp5GwqzZA
Message: "Hello test 000"

–ó–∞–¥–∞—á—ñ –≤ –ë–î:
- Task A (task_id=87639b36): active=True, text="Hello test 000"  ‚Üê –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è
- Task B (task_id=12345678): active=True, text="Hello test 000"  ‚Üê –≤ —á–µ—Ä–∑—ñ

–í–∏–∫–æ–Ω–∞–Ω–Ω—è Task A:
1. active=False –¥–ª—è Task A ‚Üí —Ç–µ–ø–µ—Ä Task A: active=False
2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤: –∑–Ω–∞—Ö–æ–¥–∏—Ç—å Task B (active=True) ‚Üí DUPLICATE!
3. ‚ùå Task A –≤—ñ–¥—Ö–∏–ª—è—î—Ç—å—Å—è —è–∫ –¥—É–±–ª—ñ–∫–∞—Ç Task B
```

## –†—ñ—à–µ–Ω–Ω—è

–ü–µ—Ä–µ–º—ñ—Å—Ç–∏–ª–∏ –æ–ø–µ—Ä–∞—Ü—ñ—é `active=False` **–ü–Ü–°–õ–Ø** –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –Ω–∞ –¥—É–±–ª—ñ–∫–∞—Ç–∏:

### –ù–æ–≤–∏–π –ø–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü—ñ–π:

1. **–ö—Ä–æ–∫ 1**: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å–ø–æ–∂–∏–≤–∞—á–∞ (consumer response check)
2. **–ö—Ä–æ–∫ 2**: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª—ñ–∫–∞—Ç–∏ `_already_sent()` - –∑–∞–¥–∞—á–∞ —â–µ `active=True`
3. **–ö—Ä–æ–∫ 3**: –Ø–∫—â–æ –¥—É–±–ª—ñ–∫–∞—Ç –∑–Ω–∞–π–¥–µ–Ω–∏–π ‚Üí `active=False` + RETURN
4. **–ö—Ä–æ–∫ 4**: –Ø–∫—â–æ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –Ω–µ–º–∞—î ‚Üí `active=False` + –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–∫—É

### –ó–º—ñ–Ω–∏ –≤ –∫–æ–¥—ñ:

```python
# BEFORE (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
if job_id:
    LeadPendingTask.objects.filter(task_id=job_id).update(active=False)  # ‚ùå –†–ê–ù–û!

if _already_sent(lead_id, text, exclude_task_id=job_id):
    return "SKIPPED: Duplicate message detected"

# AFTER (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
if _already_sent(lead_id, text, exclude_task_id=job_id):
    if job_id:
        LeadPendingTask.objects.filter(task_id=job_id).update(active=False)
    return "SKIPPED: Duplicate message detected"

# –Ø–∫—â–æ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –Ω–µ–º–∞—î:
if job_id:
    LeadPendingTask.objects.filter(task_id=job_id).update(active=False)  # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û!
# ... –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–∫—É
```

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –¢–µ—Å—Ç-–∫–µ–π—Å 1: –°–ø—Ä–∞–≤–∂–Ω—ñ–π –¥—É–±–ª—ñ–∫–∞—Ç
```python
# –ó–∞–¥–∞—á–∞ A –≤—ñ–¥–ø—Ä–∞–≤–∏–ª–∞ "Hello test 000"
# –ó–∞–¥–∞—á–∞ B –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ "Hello test 000"
# –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: Task B –≤—ñ–¥—Ö–∏–ª—è—î—Ç—å—Å—è (—Å–ø—Ä–∞–≤–∂–Ω—ñ–π –¥—É–±–ª—ñ–∫–∞—Ç)
```

### –¢–µ—Å—Ç-–∫–µ–π—Å 2: –ù–µ –¥—É–±–ª—ñ–∫–∞—Ç (–≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ —Ü–∏–º —Ñ—ñ–∫—Å–æ–º)
```python
# –ó–∞–¥–∞—á–∞ A –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∑ "Hello test 000" (active=True)
# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ ‚Üí –Ω–µ–º–∞—î –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ (Task A –≤–∏–∫–ª—é—á–∞—î—Ç—å—Å—è)
# Task A ‚Üí active=False + –≤—ñ–¥–ø—Ä–∞–≤–∫–∞
# –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è
```

### –¢–µ—Å—Ç-–∫–µ–π—Å 3: –î–≤—ñ —Ä—ñ–∑–Ω—ñ –∑–∞–¥–∞—á—ñ
```python
# –ó–∞–¥–∞—á–∞ A: "Hello test 000"
# –ó–∞–¥–∞—á–∞ B: "Hello test 001" 
# –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –û–±–∏–¥–≤—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—é—Ç—å—Å—è
```

## –§–∞–π–ª–∏ –∑–º—ñ–Ω–µ–Ω—ñ

- `/var/www/yelp/backend/webhooks/tasks.py`:
  - –õ—ñ–Ω—ñ—ó 226-229: –í–∏–¥–∞–ª–µ–Ω–æ –ø–µ—Ä–µ–¥—á–∞—Å–Ω–µ `active=False`
  - –õ—ñ–Ω—ñ—ó 335-358: –î–æ–¥–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—É –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –ø–µ—Ä–µ–¥ `active=False`

## –î–∞—Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

27.10.2025

## –ê–≤—Ç–æ—Ä

AI Assistant (–∑–∞ –∑–∞–ø–∏—Ç–æ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞)

