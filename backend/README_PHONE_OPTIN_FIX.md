# Phone Opt-In Fix - –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó

## üö® –ü—Ä–æ–±–ª–µ–º–∞ –±—É–ª–∞ –≤–∏—è–≤–ª–µ–Ω–∞

–°–∏—Å—Ç–µ–º–∞ –Ω–µ –æ–±—Ä–æ–±–ª—è–ª–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å–ø–æ–∂–∏–≤–∞—á—ñ–≤ –Ω–∞ Phone Opt-In –ø–æ—Ç–æ–∫–∏, —Ç–æ–º—É —â–æ **–≤—ñ–¥—Å—É—Ç–Ω—è –∫—Ä–∏—Ç–∏—á–Ω–∞ –ª–æ–≥—ñ–∫–∞** –¥–ª—è –≤–∏—è–≤–ª–µ–Ω–Ω—è —Ç–∞ –æ–±—Ä–æ–±–∫–∏ —Ç–∞–∫–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π.

## ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ

### 1. –î–æ–¥–∞–Ω–æ –ª–æ–≥—ñ–∫—É –≤–∏—è–≤–ª–µ–Ω–Ω—è Phone Opt-In consumer responses

–£ —Ñ–∞–π–ª—ñ `backend/webhooks/webhook_views.py` –¥–æ–¥–∞–Ω–æ –∫–æ–¥ (—Ä—è–¥–∫–∏ ~661-700):

```python
# üî• –ö–†–ò–¢–ò–ß–ù–ò–ô –§–Ü–•: –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ phone opt-in –ü–ï–†–®–ò–ú, –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é pending tasks
ld_flags = LeadDetail.objects.filter(lead_id=lid).values("phone_opt_in", "phone_number").first()
if (ld_flags and ld_flags.get("phone_opt_in")):
    # –õ–æ–≥—ñ–∫–∞ –æ–±—Ä–æ–±–∫–∏ phone opt-in consumer responses
```

### 2. –î–æ–¥–∞–Ω–æ —Ñ—É–Ω–∫—Ü—ñ—é `_cancel_pre_phone_tasks`

–ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è (—Ä—è–¥–∫–∏ ~1360-1426) —è–∫–∞ —Å–∫–∞—Å–æ–≤—É—î:
- `phone_available=False` –∑–∞–≤–¥–∞–Ω–Ω—è
- `phone_opt_in=True` –∑–∞–≤–¥–∞–Ω–Ω—è

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –î—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–∏–π —Å–∫—Ä–∏–ø—Ç
```bash
cd /var/www/yelp/backend
python debug_phone_optin.py
```

### –¢–µ—Å—Ç–æ–≤–∏–π —Å–∫—Ä–∏–ø—Ç
```bash
cd /var/www/yelp/backend
python test_phone_optin_fix.py
```

## üöÄ –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏:**
```bash
cd /var/www/yelp/backend
docker-compose restart
```

2. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏:**
```bash
docker-compose logs -f web
```

## üéØ –û—á—ñ–∫—É–≤–∞–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏

### –î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
- ‚ùå Phone opt-in consumer responses –Ω–µ –≤–∏—è–≤–ª—è–ª–∏—Å—è
- ‚ùå Phone opt-in –∑–∞–≤–¥–∞–Ω–Ω—è –Ω–µ —Å–∫–∞—Å–æ–≤—É–≤–∞–ª–∏—Å—è
- ‚ùå –°–ø–æ–∂–∏–≤–∞—á—ñ –ø—Ä–æ–¥–æ–≤–∂—É–≤–∞–ª–∏ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

### –ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
- ‚úÖ Phone opt-in consumer responses –≤–∏—è–≤–ª—è—é—Ç—å—Å—è
- ‚úÖ Phone opt-in –∑–∞–≤–¥–∞–Ω–Ω—è —Å–∫–∞—Å–æ–≤—É—é—Ç—å—Å—è –ø—Ä–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å–ø–æ–∂–∏–≤–∞—á–∞
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—î —Å—Ü–µ–Ω–∞—Ä—ñ—ó
- ‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π –¥–æ—Å–≤—ñ–¥

## üìã –õ–æ–≥–∏ –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É

–®—É–∫–∞–π—Ç–µ —Ü—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –ª–æ–≥–∞—Ö:

```
[WEBHOOK] üì± –í–ò–Ø–í–õ–ï–ù–û –í–Ü–î–ü–û–í–Ü–î–¨ –°–ü–û–ñ–ò–í–ê–ß–ê –ù–ê PHONE OPT-IN
[WEBHOOK] üöÄ –í–ò–ö–õ–ò–ö–ê–Ñ–ú–û _cancel_pre_phone_tasks –¥–ª—è phone opt-in –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
[AUTO-RESPONSE] üö´ STARTING _cancel_pre_phone_tasks
```

## üîç –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

–Ø–∫—â–æ phone opt-in –≤—Å–µ —â–µ –Ω–µ –ø—Ä–∞—Ü—é—î:

1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å `CONSUMER_PHONE_NUMBER_OPT_IN_EVENT` –≤—ñ–¥ Yelp
2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è `LeadDetail.phone_opt_in=True`
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ —î –∞–∫—Ç–∏–≤–Ω—ñ `phone_opt_in=True` –∑–∞–≤–¥–∞–Ω–Ω—è
4. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ webhook –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –ø–æ–º–∏–ª–æ–∫

## üìû –ü—ñ–¥—Ç—Ä–∏–º–∫–∞

–Ø–∫—â–æ –ø—Ä–æ–±–ª–µ–º–∏ –ø—Ä–æ–¥–æ–≤–∂—É—é—Ç—å—Å—è, –Ω–∞–¥—ñ—à–ª—ñ—Ç—å:
1. –õ–æ–≥–∏ webhook –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ lead_id
2. –†–µ–∑—É–ª—å—Ç–∞—Ç –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
3. –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ AutoResponseSettings –¥–ª—è business
